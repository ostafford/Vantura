<%= form_with(model: @project, local: true, data: { turbo: false }) do |f| %>
  <% if @project.errors.any? %>
    <div class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
      <h3 class="text-sm font-medium text-red-800 dark:text-red-300 mb-2">Please fix the following errors:</h3>
      <ul class="list-disc list-inside text-sm text-red-700 dark:text-red-400">
        <% @project.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-6">
    <%= f.label :name, class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
    <%= f.text_field :name, class: "w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors" %>
  </div>

  <div class="mb-6">
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Members</label>
    <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Owner is automatically included. Start typing to filter users by name or email. Select multiple members.</p>
    <input type="text" id="member-search" placeholder="Search users..." class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 mb-3 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors">
    <div class="max-h-64 overflow-auto border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/50">
      <% User.order(:email_address).limit(100).each do |user| %>
        <% next if user.id == Current.user.id %>
        <% is_checked = @project.persisted? && @project.members.include?(user) %>
        <% membership = @project.persisted? ? @project.project_memberships.find { |m| m.user_id == user.id } : nil %>
        <label class="flex items-center gap-3 px-4 py-3 border-b border-gray-200 dark:border-gray-700 last:border-b-0 bg-white dark:bg-gray-900 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition-colors">
          <input type="checkbox" name="member_user_ids[]" value="<%= user.id %>" class="member-option w-4 h-4 rounded border-gray-300 dark:border-gray-600 text-primary-600 focus:ring-primary-500 focus:ring-2" <%= 'checked' if is_checked %>>
          <div class="flex-1">
            <span class="text-sm font-medium text-gray-900 dark:text-gray-100"><%= user_display_name(user) %></span>
            <span class="text-xs text-gray-500 dark:text-gray-400 ml-2"><%= user.email_address %></span>
          </div>
          <div class="w-48">
            <select name="member_access_levels[<%= user.id %>]" class="member-role block w-full rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-xs px-2 py-1.5 focus:ring-primary-500 focus:border-primary-500 <%= is_checked ? '' : 'hidden' %>">
              <option value="limited" <%= membership&.limited? ? 'selected' : '' %>>Limited access</option>
              <option value="full" <%= membership&.full? ? 'selected' : '' %>>Full access</option>
            </select>
          </div>
        </label>
      <% end %>
    </div>
    <script>
      document.addEventListener('turbo:load', function(){
        var input = document.getElementById('member-search');
        if(!input) return;
        input.addEventListener('input', function(){
          var q = this.value.toLowerCase();
          document.querySelectorAll('.member-option').forEach(function(cb){
            var label = cb.closest('label');
            var text = label.textContent.toLowerCase();
            label.style.display = text.indexOf(q) >= 0 ? '' : 'none';
          });
        });

        // Toggle role select visibility based on checkbox state
        document.querySelectorAll('.member-option').forEach(function(cb){
          var label = cb.closest('label');
          var select = label.querySelector('.member-role');
          cb.addEventListener('change', function(){
            if (select) {
              if (cb.checked) {
                select.classList.remove('hidden');
              } else {
                select.classList.add('hidden');
              }
            }
          });
        });
      });
    </script>
  </div>

  <div class="flex gap-3 pt-6 border-t border-gray-200 dark:border-gray-700">
    <%= f.submit (@project.persisted? ? "Update Project" : "Create Project"), class: "px-6 py-2.5 bg-primary-600 hover:bg-primary-700 dark:bg-primary-500 dark:hover:bg-primary-600 text-white rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2" %>
    <%= link_to "Cancel", (@project.persisted? ? project_path(@project) : projects_path), class: "px-6 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" %>
  </div>
<% end %>


