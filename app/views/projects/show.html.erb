<% content_for :title, "#{@project.name} - Projects - Vantura" %>

<main>
  <!-- Breadcrumb Navigation -->
  <div class="bg-gradient-to-r from-cream-100 to-white dark:from-primary-900 dark:to-primary-950 border-b border-primary-700/20 dark:border-primary-900/30">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
      <div class="flex items-center gap-2">
        <%= link_to projects_path, class: "text-sm text-gray-600 dark:text-gray-400 hover:text-primary-700 dark:hover:text-primary-400 font-medium transition-colors" do %>
          Projects
        <% end %>
        <span class="text-sm text-gray-400 dark:text-gray-500">/</span>
        <span class="text-sm text-gray-900 dark:text-white font-medium"><%= @project.name %></span>
      </div>
    </div>
  </div>

  <!-- Page Header -->
  <%= render 'shared/page_header_simple', title: @project.name, subtitle: "View project details and expenses", hide_quick_actions: true do %>
    <% can_manage = (@project.owner_id == Current.user.id) || @project.project_memberships.where(user_id: Current.user.id, access_level: ProjectMembership.access_levels[:full]).exists? %>
    <% if can_manage %>
      <div class="flex gap-2">
        <%= link_to new_project_expense_path(@project), class: "inline-flex items-center justify-center w-12 h-12 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:scale-110 hover:shadow-lg transition-all", title: "Add expense" do %>
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
        <% end %>
        
        <%= link_to edit_project_path(@project), class: "inline-flex items-center justify-center w-12 h-12 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:scale-110 hover:shadow-lg transition-all", title: "Edit project" do %>
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
        <% end %>
        
        <% if @project.owner_id == Current.user.id %>
          <%= button_to project_path(@project), method: :delete, form: { data: { turbo_confirm: "Delete this project?" }, class: "inline" }, class: "inline-flex items-center justify-center w-12 h-12 bg-white dark:bg-gray-800 border border-red-300 dark:border-red-600 rounded-xl text-red-700 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 hover:scale-110 hover:shadow-lg transition-all", title: "Delete project" do %>
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
          <% end %>
        <% end %>
      </div>
    <% end %>
  <% end %>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Bento Grid Statistics Section -->
    <section id="project_statistics_bento" class="bento-grid mb-6" aria-label="Project statistics">
      <!-- Hero Card (2x2) -->
      <%= render 'shared/bento_cards/hero_card',
          title: @project.name,
          subtitle: @total_expenses_cents > 0 ? format_cents(@total_expenses_cents) : "No expenses yet",
          description: "Overview of project expenses, participants, and activity. Track shared costs and monitor contributions across all project expenses.",
          icon: 'chart',
          size: 'bento-span-2 bento-row-span-2',
          color: 'primary' do %>
        <div class="mt-6 space-y-4">
          <!-- Owner Section -->
          <div class="pb-3 border-b border-white/20">
            <div class="text-white/80 text-xs font-medium mb-2 uppercase tracking-wider">Owner</div>
            <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-white/20 backdrop-blur-sm rounded-lg border border-white/30">
              <div class="w-8 h-8 rounded-full bg-white/30 flex items-center justify-center text-white font-semibold text-sm">
                <%= user_display_name(@project.owner).first.upcase %>
              </div>
              <span class="text-white font-semibold"><%= user_display_name(@project.owner) %></span>
            </div>
          </div>
          
          <!-- Members Section -->
          <% if @project.members.any? %>
            <div>
              <div class="text-white/80 text-xs font-medium mb-2 uppercase tracking-wider">Members</div>
              <div class="flex flex-wrap gap-2">
                <% membership_by_user = @project.project_memberships.index_by(&:user_id) %>
                <% @project.members.each do |member| %>
                  <% level = membership_by_user[member.id]&.access_level || 'limited' %>
                  <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-white/15 backdrop-blur-sm rounded-lg border border-white/25">
                    <div class="w-7 h-7 rounded-full bg-white/25 flex items-center justify-center text-white font-medium text-xs">
                      <%= user_display_name(member).first.upcase %>
                    </div>
                    <span class="text-white/90 text-sm"><%= user_display_name(member) %></span>
                    <span class="ml-2 text-[10px] uppercase tracking-wide px-2 py-0.5 rounded bg-white/20 text-white/90 border border-white/30">
                      <%= level == 'full' ? 'Full' : 'Limited' %>
                    </span>
                  </div>
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="text-white/60 text-sm italic">
              No additional members
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Total Expenses Card -->
      <%= render 'shared/bento_cards/stat_card',
          id: 'project_total_expenses_card',
          title: "Total Expenses",
          value: format_cents(@total_expenses_cents),
          subtitle: "<span class='font-semibold text-gray-900 dark:text-white'>#{@expense_count}</span> #{'expense'.pluralize(@expense_count)}".html_safe,
          detail: "All project expenses",
          icon: 'dollar',
          color: 'red',
          size: 'bento-span-1 bento-row-span-1' %>

      <!-- Expense Count Card -->
      <%= render 'shared/bento_cards/stat_card',
          id: 'project_expense_count_card',
          title: "Expense Count",
          value: @expense_count.to_s,
          subtitle: "<span class='font-semibold text-gray-900 dark:text-white'>#{format_cents(@total_expenses_cents)}</span> total".html_safe,
          detail: "Expenses tracked",
          icon: 'chart',
          color: 'blue',
          size: 'bento-span-1 bento-row-span-1' %>

      <!-- Participants Card -->
      <%= render 'shared/bento_cards/stat_card',
          id: 'project_participants_card',
          title: "Participants",
          value: @total_participants.to_s,
          subtitle: "<span class='font-semibold text-gray-900 dark:text-white'>#{@expense_count}</span> #{'expense'.pluralize(@expense_count)}".html_safe,
          detail: "Collaborating on project",
          icon: 'chart',
          color: 'blue',
          size: 'bento-span-2 bento-row-span-1' %>

      <!-- Monthly Bar Chart Card (bento 2x2) -->
      <%= render 'shared/bento_cards/bar_chart_card', project: @project, title: 'Monthly Expenses', year: @date.year, month: @date.month %>

      <!-- Unpaid Contributions Card -->
      <%= render 'shared/bento_cards/stat_card',
          id: 'project_unpaid_contributions_card',
          title: "Unpaid Contributions",
          value: @unpaid_contributions_count.to_s,
          subtitle: "<span class='font-semibold text-gray-900 dark:text-white'>#{@expense_count}</span> #{'expense'.pluralize(@expense_count)}".html_safe,
          detail: "Outstanding payments",
          icon: 'warning',
          color: 'red',
          size: 'bento-span-1 bento-row-span-1' %>
    </section>

    <!-- Global Month Navigation (consistent with Calendar) -->
    <%= render 'shared/month_navigation',
        prev_path: project_path(@project, year: (@date.prev_month.year), month: (@date.prev_month.month)),
        next_path: project_path(@project, year: (@date.next_month.year), month: (@date.next_month.month)),
        title: @date.strftime("%B %Y") do %>
      <!-- Right-side actions slot -->
      <%= link_to new_project_path,
          class: "inline-flex items-center justify-center w-12 h-12 bg-primary-600 hover:bg-primary-700 dark:bg-primary-500 dark:hover:bg-primary-600 text-white rounded-xl border border-primary-600 dark:border-primary-500 hover:shadow-lg hover:scale-105 transition-all",
          title: "New Project" do %>
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
      <% end %>
    <% end %>

    <!-- Expenses Table Section -->
    <section class="bg-gradient-to-br from-neutral-100 to-white dark:from-gray-800 dark:to-gray-900 rounded-lg shadow-sm border-2 border-gray-200 dark:border-gray-700" aria-label="Project expenses list">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white">Project Expenses</h2>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-900">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Merchant</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Category</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Total</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Due</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Notes</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="project_expenses_table_body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            <% if @expenses.any? %>
              <% @expenses.each do |expense| %>
                <tr data-controller="expense-row" data-action="click->expense-row#toggle" class="cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center gap-2">
                      <svg class="w-4 h-4 text-gray-400 chevron-icon transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                      </svg>
                      <span class="text-sm text-gray-900 dark:text-gray-100"><%= expense.merchant %></span>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100"><%= expense.category %></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100"><%= format_cents(expense.total_cents) %></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100"><%= expense.due_on&.strftime('%Y-%m-%d') %></td>
                  <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-100"><%= expense.notes %></td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium" onclick="event.stopPropagation()">
                    <% if @project.owner_id == Current.user.id %>
                      <%= link_to "Edit", edit_project_expense_path(@project, expense), class: "text-primary-700 dark:text-primary-400 hover:text-primary-900 dark:hover:text-primary-300 mr-3" %>
                      <%= button_to "Delete", project_expense_path(@project, expense), method: :delete, form: { data: { turbo_confirm: "Delete this expense?" }, class: "inline" }, class: "text-red-700 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300" %>
                    <% end %>
                  </td>
                </tr>
                <tr data-expense-row-target="contributions" class="hidden">
                  <td colspan="6" class="px-6 pb-4 bg-gray-50 dark:bg-gray-800/50">
                    <div class="rounded-lg border border-gray-200 dark:border-gray-700 p-4 bg-white dark:bg-gray-900">
                      <div class="font-medium mb-3 text-sm text-gray-900 dark:text-white">Contributions</div>
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <% expense.expense_contributions.includes(:user).each do |contrib| %>
                          <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-3">
                            <div>
                              <div class="text-sm font-medium text-gray-900 dark:text-gray-100"><%= user_display_name(contrib.user) %></div>
                              <div class="text-xs text-gray-500 dark:text-gray-400 mt-1"><%= format_cents(contrib.share_cents) %></div>
                            </div>
                            <div>
                              <% if can_toggle_paid?(contrib) %>
                                <%= form_with(model: [@project, expense, contrib], url: project_expense_contribution_path(@project, expense, contrib), method: :patch) do |ff| %>
                                  <label class="inline-flex items-center gap-2 text-sm cursor-pointer">
                                    <%= ff.check_box :paid, { checked: contrib.paid, onchange: 'this.form.submit()', include_hidden: true, class: "rounded border-gray-300 text-primary-600 focus:ring-primary-500" }, true, false %>
                                    <span class="text-gray-700 dark:text-gray-300"><%= contrib.paid ? 'Paid' : 'Unpaid' %></span>
                                  </label>
                                <% end %>
                              <% else %>
                                <span class="text-sm <%= contrib.paid ? 'text-green-600 dark:text-green-400' : 'text-gray-500 dark:text-gray-400' %>">
                                  <%= contrib.paid ? 'Paid' : 'Not paid' %>
                                </span>
                              <% end %>
                            </div>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="6" class="px-6 py-12 text-center">
                  <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No expenses yet</h3>
                  <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by adding your first expense.</p>
                  <% if @project.owner_id == Current.user.id %>
                    <%= link_to "Add Expense", new_project_expense_path(@project), class: "mt-4 inline-flex items-center px-4 py-2 bg-primary-600 hover:bg-primary-700 dark:bg-primary-500 dark:hover:bg-primary-600 text-white rounded-lg font-medium transition-colors" %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </section>
  </div>
</main>
