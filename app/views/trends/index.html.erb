<% content_for :title, "Trends - Vantura" %>

<div>
  <!-- Page Header -->
  <%= render 'shared/page_header_simple', title: "Trends & Insights", subtitle: "Analyze your financial patterns and trends" %>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <% if @account %>
      <!-- Bento Grid Layout -->
      <div class="bento-grid mb-6">
        
        <!-- 1. Key Insights Hub (2x2 Hero Card) -->
        <%= render 'shared/bento_cards/hero_card',
            title: "Financial Insights",
            subtitle: "#{@current_date.strftime('%B %Y')}",
            icon: 'chart',
            size: 'bento-span-2 bento-row-span-2',
            color: 'secondary' do %>
          <div class="mt-6 space-y-4">
            <div class="flex items-center justify-between pb-3 border-b border-white/20">
              <span class="text-white/80 text-sm">Net Savings</span>
              <%# White for positive, bright red for negative - both have good contrast on sage green background %>
              <span class="text-2xl font-bold <%= @net_savings >= 0 ? 'text-white' : 'text-red-400' %>">
                <%= @net_savings >= 0 ? "+" : "-" %>$<%= number_with_precision(@net_savings.abs, precision: 2) %>
              </span>
            </div>
            <div class="flex items-center justify-between pb-3 border-b border-white/20">
              <span class="text-white/80 text-sm">Active Recurring</span>
              <span class="text-xl font-semibold text-white"><%= @active_recurring_count %> patterns</span>
            </div>
            <div class="pt-2">
              <p class="text-white/70 text-xs leading-relaxed">
                Track your financial trends, compare month-over-month changes, and gain insights into your spending patterns.
              </p>
            </div>
          </div>
        <% end %>

        <!-- 2. Net Savings Card (1x1) -->
        <%
          savings_positive = @net_savings >= 0
          savings_color = savings_positive ? 'green' : 'red'  # Green for positive, Red for negative
          savings_icon = savings_positive ? 'arrow-up' : 'arrow-down'
          savings_subtitle = savings_positive ? "Surplus" : "Deficit"
        %>
        <%= render 'shared/bento_cards/stat_card',
            title: "Net Savings",
            value: "#{savings_positive ? '+' : '-'}$#{number_with_precision(@net_savings.abs, precision: 2)}",
            subtitle: "<span class='font-semibold text-gray-900 dark:text-white'>#{savings_subtitle}</span>".html_safe,
            detail: "#{@current_date.strftime('%B %Y')}",
            icon: savings_icon,
            color: savings_color,  # Stat card uses red/green correctly
            size: 'bento-span-1 bento-row-span-1',
            id: 'net_savings_card' %>

        <!-- 3. Active Recurring Card (1x1) - Clickable -->
        <%= render 'shared/bento_cards/stat_card',
            title: "Active Recurring",
            value: @active_recurring_count.to_s,
            subtitle: "<span class='font-semibold text-gray-900 dark:text-white'>#{@active_recurring_count == 1 ? 'pattern' : 'patterns'}</span>".html_safe,
            detail: "Click to manage",
            icon: 'refresh',
            color: 'blue',
            size: 'bento-span-1 bento-row-span-1',
            link: recurring_transactions_path %>

        <!-- 4. Month Comparison Card (1x2) - Custom Card -->
        <div class="bento-span-1 bento-row-span-2 bg-gradient-to-br from-cream-100 to-white dark:from-primary-700 dark:to-primary-900 rounded-2xl shadow-lg p-6 border-2 border-primary-700/20 dark:border-primary-900/30">
          <div class="flex flex-col h-full">
            <!-- Header -->
            <div class="mb-4">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Month Comparison</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                <%= @current_date.strftime('%B') %> vs <%= @current_date.prev_month.strftime('%B') %>
              </p>
            </div>

            <!-- Comparison Rows -->
            <div class="flex-1 space-y-4">
              <!-- Income Row -->
              <div class="flex items-center justify-between pb-3 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-2">
                  <div class="w-2 h-2 rounded-full bg-secondary-500 dark:bg-secondary-300"></div>
                  <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Income</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-sm font-semibold text-secondary-500 dark:text-secondary-300">
                    $<%= number_with_precision(@current_month_income, precision: 0) %>
                  </span>
                  <% if @income_change_pct != 0 %>
                    <%# Income: Up arrow (earning more) = GREEN, Down arrow (earning less) = RED %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium <%= @income_change_pct > 0 ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300' : 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300' %>">
                      <%= @income_change_pct > 0 ? "↑" : "↓" %><%= @income_change_pct.abs %>%
                    </span>
                  <% end %>
                </div>
              </div>

              <!-- Expenses Row -->
              <div class="flex items-center justify-between pb-3 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-2">
                  <div class="w-2 h-2 rounded-full bg-coral-500 dark:bg-coral-400"></div>
                  <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Expenses</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-sm font-semibold text-coral-500 dark:text-coral-400">
                    $<%= number_with_precision(@current_month_expenses, precision: 0) %>
                  </span>
                  <% if @expense_change_pct != 0 %>
                    <%# Expenses: Up arrow (spending more) = RED, Down arrow (spending less) = GREEN %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium <%= @expense_change_pct > 0 ? 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300' : 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300' %>">
                      <%= @expense_change_pct > 0 ? "↑" : "↓" %><%= @expense_change_pct.abs %>%
                    </span>
                  <% end %>
                </div>
              </div>

              <!-- Net Row -->
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <div class="w-2 h-2 rounded-full bg-primary-700 dark:bg-primary-500"></div>
                  <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Net</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-sm font-semibold <%= @net_savings >= 0 ? 'text-secondary-500 dark:text-secondary-300' : 'text-coral-500 dark:text-coral-400' %>">
                    <%= @net_savings >= 0 ? "+" : "-" %>$<%= number_with_precision(@net_savings.abs, precision: 0) %>
                  </span>
                  <% if @net_change_pct != 0 %>
                    <%# Net: Up arrow (improving savings) = GREEN, Down arrow (declining savings) = RED %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium <%= @net_change_pct > 0 ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300' : 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300' %>">
                      <%= @net_change_pct > 0 ? "↑" : "↓" %><%= @net_change_pct.abs %>%
                    </span>
                  <% end %>
                </div>
              </div>
            </div>

            <!-- Footer -->
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
              <p class="text-xs text-gray-500 dark:text-gray-400">
                Comparing real transactions only
              </p>
            </div>
          </div>
        </div>

        <!-- 5. Top Merchant Card (1x1) -->
        <%# Shows total spend across ALL purchases from this merchant (grouped and summed) %>
        <%= render 'shared/bento_cards/stat_card',
            title: "Top Merchant",
            value: "$#{number_with_precision(@top_merchant[:amount], precision: 2)}",
            subtitle: "<span class='font-semibold text-gray-900 dark:text-white'>#{truncate(@top_merchant[:name], length: 20)}</span>".html_safe,
            detail: "Total spent this month",
            icon: 'chart',
            color: 'gold',
            size: 'bento-span-1 bento-row-span-1' %>

        <!-- 6. View Advanced Analysis Card (2x1) - CTA -->
        <div class="bento-span-2 bento-row-span-1 bg-gradient-to-r from-primary-700/10 to-secondary-500/10 dark:from-primary-900/20 dark:to-secondary-700/20 rounded-2xl shadow-lg p-6 border-2 border-primary-700/20 dark:border-primary-500/20">
          <div class="flex items-center justify-between h-full gap-4">
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Advanced Analysis Coming Soon</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">
                Compare merchants, categories, and time periods with custom filters and beautiful visualizations.
              </p>
            </div>
            <div class="inline-flex items-center justify-center w-12 h-12 bg-primary-700/10 dark:bg-primary-500/20 rounded-xl">
              <svg class="w-6 h-6 text-primary-700 dark:text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
            </div>
          </div>
        </div>

      </div>

      <!-- Additional Info Section -->
      <div class="bg-gradient-to-br from-cream-100 to-white dark:from-primary-700 dark:to-primary-900 rounded-2xl shadow-lg p-6 border-2 border-secondary-500/20 dark:border-secondary-700/30">
        <div class="flex items-start gap-4">
          <div class="flex-shrink-0">
            <div class="inline-flex items-center justify-center w-12 h-12 bg-secondary-500/10 dark:bg-secondary-700/20 rounded-xl">
              <svg class="w-6 h-6 text-secondary-500 dark:text-secondary-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">About Trends & Insights</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 leading-relaxed mb-3">
              This page provides a quick overview of your financial trends for the current month. All calculations are based on <strong>real transactions only</strong> (hypothetical/projected transactions are excluded).
            </p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-600 dark:text-gray-400">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-secondary-500 dark:text-secondary-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Month-over-month comparisons</span>
              </div>
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-secondary-500 dark:text-secondary-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Real-time data from Up Bank</span>
              </div>
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-secondary-500 dark:text-secondary-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Net savings tracking</span>
              </div>
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-secondary-500 dark:text-secondary-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Top merchant analysis</span>
              </div>
            </div>
          </div>
        </div>
      </div>

    <% else %>
      <!-- No Account Message -->
      <div class="bg-gradient-to-br from-cream-100 to-white dark:from-primary-700 dark:to-primary-900 rounded-lg shadow-sm border-2 border-primary-700/30 dark:border-primary-900/30 p-12 text-center">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">No account found</h2>
        <p class="text-gray-600 dark:text-gray-400">Please sync your Up Bank account first.</p>
        <%= link_to "Go to Settings", settings_path, class: "inline-flex items-center mt-4 px-6 py-3 bg-primary-700 text-white rounded-lg hover:bg-primary-900 transition-colors" %>
      </div>
    <% end %>
  </div>
</div>
