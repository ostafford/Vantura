<% content_for :title, "Trends - Vantura" %>

<main id="main" aria-label="Trends and insights page">
  <!-- Page Header -->
  <%= render 'shared/page_header_simple', title: "Trends & Insights", subtitle: "Analyze your financial patterns and trends" %>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <% if @account %>
      <!-- Bento Grid Layout -->
      <div class="bento-grid mb-6">
        
        <!-- 1. Key Insights Hub (2x2 Hero Card) -->
        <%= render 'shared/bento_cards/hero_card',
            title: "Financial Insights",
            subtitle: "#{@current_date.strftime('%B %Y')}",
            description: "Track your financial trends, compare month-over-month changes, and gain insights into your spending patterns.",
            icon: 'chart',
            size: 'bento-span-2 bento-row-span-2',
            color: 'success' do %>
          <div class="mt-6 space-y-4">
            <div class="flex items-center justify-between pb-3 border-b border-white/20">
              <span class="text-white/80 text-sm">Net Savings</span>
              <%# White for positive, expense color for negative - both have good contrast on sage green background %>
              <span class="text-2xl font-bold <%= @net_savings >= 0 ? 'text-white' : 'text-expense-400 dark:text-expense-200 drop-shadow-md' %>">
                <%= @net_savings >= 0 ? "+" : "-" %>$<%= number_with_precision(@net_savings.abs, precision: 2) %>
              </span>
            </div>
            <div class="flex items-center justify-between pb-3 border-b border-white/20">
              <span class="text-white/80 text-sm">Active Recurring</span>
              <span class="text-xl font-semibold text-white"><%= @active_recurring_count %> patterns</span>
            </div>
          </div>
        <% end %>

        <!-- 2. Net Savings Card (1x1) -->
        <%
          savings_positive = @net_savings >= 0
          savings_color = savings_positive ? 'green' : 'red'  # Green for positive, Red for negative
          savings_icon = savings_positive ? 'arrow-up' : 'arrow-down'
          savings_subtitle = savings_positive ? "Surplus" : "Deficit"
        %>
        <%= render 'shared/bento_cards/stat_card',
            title: "Net Savings",
            value: "#{savings_positive ? '+' : '-'}$#{number_with_precision(@net_savings.abs, precision: 2)}",
            subtitle: "<span class='font-semibold text-gray-900 dark:text-white'>#{savings_subtitle}</span>".html_safe,
            detail: "#{@current_date.strftime('%B %Y')}",
            icon: savings_icon,
            color: savings_color,  # Stat card uses red/green correctly
            size: 'bento-span-1 bento-row-span-1',
            id: 'net_savings_card' %>

        <!-- 3. Active Recurring Card (1x1) - Clickable -->
        <%= render 'shared/bento_cards/stat_card',
            title: "Active Recurring",
            value: @active_recurring_count.to_s,
            subtitle: "<span class='font-semibold text-gray-900 dark:text-white'>#{@active_recurring_count == 1 ? 'pattern' : 'patterns'}</span>".html_safe,
            detail: "Click to manage",
            icon: 'refresh',
            color: 'blue',
            size: 'bento-span-1 bento-row-span-1',
            link: recurring_transactions_path %>

        <!-- 4. Month Comparison Card (1x1) - Compact Version -->
        <div class="bento-span-1 bento-row-span-1 bg-gradient-to-br from-neutral-100 to-white dark:from-primary-700 dark:to-primary-900 rounded-2xl shadow-lg p-6 border-2 border-primary-700/20 dark:border-primary-900/30">
          <div class="flex flex-col h-full">
            <!-- Header -->
            <div class="mb-3">
              <h3 class="text-base font-semibold text-gray-900 dark:text-white">Month Comparison</h3>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                <%= @current_date.strftime('%b') %> vs <%= @current_date.prev_month.strftime('%b') %>
              </p>
            </div>

            <!-- Compact Comparison -->
            <div class="flex-1 space-y-2 text-sm">
              <!-- Income -->
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-1.5">
                  <div class="w-1.5 h-1.5 rounded-full bg-success-500 dark:bg-success-300"></div>
                  <span class="text-xs text-gray-600 dark:text-gray-400">Income</span>
                </div>
                <div class="flex items-center gap-1">
                  <span class="text-xs font-semibold text-success-500 dark:text-success-300">
                    $<%= number_with_precision(@current_month_income, precision: 0) %>
                  </span>
                  <% if @income_change_pct != 0 %>
                    <span class="text-xs <%= @income_change_pct > 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400' %>">
                      <%= @income_change_pct > 0 ? "↑" : "↓" %><%= @income_change_pct.abs %>%
                    </span>
                  <% end %>
                </div>
              </div>

              <!-- Expenses -->
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-1.5">
                  <div class="w-1.5 h-1.5 rounded-full bg-expense-500 dark:bg-expense-400"></div>
                  <span class="text-xs text-gray-600 dark:text-gray-400">Expenses</span>
                </div>
                <div class="flex items-center gap-1">
                  <span class="text-xs font-semibold text-expense-500 dark:text-expense-400">
                    $<%= number_with_precision(@current_month_expenses, precision: 0) %>
                  </span>
                  <% if @expense_change_pct != 0 %>
                    <span class="text-xs <%= @expense_change_pct > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400' %>">
                      <%= @expense_change_pct > 0 ? "↑" : "↓" %><%= @expense_change_pct.abs %>%
                    </span>
                  <% end %>
                </div>
              </div>

              <!-- Net -->
              <div class="flex items-center justify-between pt-2 border-t border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-1.5">
                  <div class="w-1.5 h-1.5 rounded-full bg-primary-700 dark:bg-primary-500"></div>
                  <span class="text-xs font-semibold text-gray-900 dark:text-white">Net</span>
                </div>
                <div class="flex items-center gap-1">
                  <span class="text-xs font-bold <%= @net_savings >= 0 ? 'text-success-600 dark:text-success-400' : 'text-expense-600 dark:text-expense-400' %>">
                    <%= @net_savings >= 0 ? "+" : "-" %>$<%= number_with_precision(@net_savings.abs, precision: 0) %>
                  </span>
                  <% if @net_change_pct != 0 %>
                    <span class="text-xs <%= @net_change_pct > 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400' %>">
                      <%= @net_change_pct > 0 ? "↑" : "↓" %><%= @net_change_pct.abs %>%
                    </span>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 5. Top Merchant Card (1x2) - Expanded -->
        <div class="bento-span-1 bento-row-span-2 bg-gradient-to-br from-neutral-100 to-white dark:from-primary-700 dark:to-primary-900 rounded-2xl shadow-lg p-6 border-2 border-primary-700/20 dark:border-primary-900/30">
          <div class="flex flex-col h-full">
            <!-- Header -->
            <div class="mb-4">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Top Merchant</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                <%= @current_date.strftime('%B %Y') %>
              </p>
            </div>

            <!-- Merchant Details -->
            <div class="flex-1 space-y-4">
              <!-- Merchant Name -->
              <div class="pb-3 border-b border-gray-200 dark:border-gray-700">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Merchant Name</p>
                <p class="text-lg font-bold text-gray-900 dark:text-white">
                  <%= truncate(@top_merchant[:name], length: 25) %>
                </p>
              </div>

              <!-- Total Amount -->
              <div class="pb-3 border-b border-gray-200 dark:border-gray-700">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Total Spent</p>
                <p class="text-2xl font-bold text-income-500 dark:text-income-400">
                  $<%= number_with_precision(@top_merchant[:amount], precision: 2) %>
                </p>
              </div>

              <!-- Percentage -->
              <% total_expenses = @current_month_expenses %>
              <% if total_expenses > 0 %>
                <% merchant_pct = ((@top_merchant[:amount] / total_expenses) * 100).round(1) %>
                <div>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">of Total Expenses</p>
                  <p class="text-3xl font-bold text-primary-700 dark:text-primary-400">
                    <%= merchant_pct %>%
                  </p>
                </div>
              <% else %>
                <div>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">of Total Expenses</p>
                  <p class="text-3xl font-bold text-primary-700 dark:text-primary-400">
                    N/A
                  </p>
                </div>
              <% end %>
            </div>

            <!-- Footer -->
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
              <p class="text-xs text-gray-500 dark:text-gray-400">
                Based on real transactions
              </p>
            </div>
          </div>
        </div>

        <!-- 6. View Advanced Analysis Card (2x1) - Clickable -->
        <%= render 'shared/bento_cards/stat_card',
            title: "Advanced Analysis",
            value: "View Details",
            subtitle: "<span class='font-semibold text-gray-900 dark:text-white'>Deep insights</span>".html_safe,
            detail: "Compare merchants, categories, and time periods",
            icon: 'chart',
            color: 'blue',
            size: 'bento-span-2 bento-row-span-1'%>

      </div>

      <!-- Charts Section (React Components) -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Income vs Expenses Chart -->
        <div class="bg-gradient-to-br from-neutral-100 to-white dark:from-primary-700 dark:to-primary-900 rounded-2xl shadow-lg p-6 border-2 border-primary-700/20 dark:border-primary-900/30">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Income vs Expenses</h3>
          <div 
            data-react-mount="IncomeExpenseChart"
            data-props='<%= { height: 400 }.to_json.html_safe %>'
          ></div>
        </div>

        <!-- Category Breakdown Chart -->
        <div class="bg-gradient-to-br from-neutral-100 to-white dark:from-primary-700 dark:to-primary-900 rounded-2xl shadow-lg p-6 border-2 border-primary-700/20 dark:border-primary-900/30">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Top Merchant Breakdown</h3>
          <div 
            data-react-mount="CategoryBreakdownChart"
            data-props='<%= { height: 400 }.to_json.html_safe %>'
          ></div>
        </div>
      </div>

      <!-- Additional Info Section -->
      <div class="bg-gradient-to-br from-neutral-100 to-white dark:from-primary-700 dark:to-primary-900 rounded-2xl shadow-lg p-6 border-2 border-success-500/20 dark:border-success-700/30">
        <div class="flex items-start gap-4">
          <div class="flex-shrink-0">
            <div class="inline-flex items-center justify-center w-12 h-12 bg-success-500/10 dark:bg-success-700/20 rounded-xl">
              <svg class="w-6 h-6 text-success-500 dark:text-success-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">About Trends & Insights</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 leading-relaxed mb-3">
              This page provides a quick overview of your financial trends for the current month. All calculations are based on <strong>real transactions only</strong> (hypothetical/projected transactions are excluded).
            </p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-600 dark:text-gray-400">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-success-500 dark:text-success-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Month-over-month comparisons</span>
              </div>
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-success-500 dark:text-success-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Real-time data from Up Bank</span>
              </div>
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-success-500 dark:text-success-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Net savings tracking</span>
              </div>
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-success-500 dark:text-success-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Top merchant analysis</span>
              </div>
            </div>
          </div>
        </div>
      </div>

    <% else %>
      <!-- No Account Message -->
      <div class="bg-gradient-to-br from-neutral-100 to-white dark:from-primary-700 dark:to-primary-900 rounded-lg shadow-sm border-2 border-primary-700/30 dark:border-primary-900/30 p-12 text-center">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">No account found</h2>
        <p class="text-gray-600 dark:text-gray-400">Please sync your Up Bank account first.</p>
        <%= link_to "Go to Settings", settings_path, class: "inline-flex items-center mt-4 px-6 py-3 bg-primary-700 text-white rounded-lg hover:bg-primary-900 transition-colors" %>
      </div>
    <% end %>
  </div>
</main>
