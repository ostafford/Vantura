<% content_for :title, "Advanced Analysis - Vantura" %>

<main role="main">
  <!-- Page Header -->
  <%= render 'shared/page_header_simple', title: "Advanced Analysis", subtitle: "Deep insights into your financial patterns" do %>
    <div class="flex gap-3">
      <%= link_to trends_path, class: "inline-flex items-center px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors", aria: { label: "Navigate back to trends page" } do %>
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Trends
      <% end %>
    </div>
  <% end %>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6" data-modal-target="content">
    <% if @account %>
      <!-- Hero Card -->
      <%= render 'shared/bento_cards/hero_card',
          title: "Advanced Analysis",
          subtitle: @selected_filter ? @selected_filter.name : @current_date.strftime('%B %Y'),
          description: "Deep insights into your spending patterns with interactive pie charts, bar charts, and line graphs. Create custom filters by category, merchant, status, or recurring patterns. Analyze your financial data from multiple perspectives to identify trends and make informed decisions.",
          icon: 'chart',
          size: 'bento-span-2 bento-row-span-2',
          color: 'blue' do %>
        <div class="flex items-center justify-between mb-3">
          <p class="text-blue-50 text-sm">Total: <%= number_to_currency(@breakdown_data.values.sum(&:abs)) %></p>
          <p class="text-blue-100 text-xs">
            Income: <%= number_to_currency(@current_month_income) %> • Expenses: <%= number_to_currency(@current_month_expenses) %>
          </p>
        </div>
        <p class="text-blue-50 text-xs">Views: Pie Chart • Bar Chart • Line Chart • Custom Filters</p>
      <% end %>
      
      <!-- Bento Grid Layout -->
      <section aria-labelledby="summary-heading" class="bento-grid mb-6">
        <h2 id="summary-heading" class="sr-only">Financial Summary</h2>
        
        <!-- Category Breakdown Card (1x1) -->
        <article class="bento-span-1 bento-row-span-1 bg-gradient-to-br from-neutral-100 to-white dark:from-primary-700 dark:to-primary-900 rounded-2xl shadow-lg p-6 border-2 border-primary-700/20 dark:border-primary-900/30">
          <div class="flex flex-col h-full">
            <!-- Header -->
            <header class="mb-4">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Top Categories</h3>
                <div class="inline-flex items-center justify-center w-8 h-8 bg-primary-700/10 dark:bg-primary-500/20 rounded-lg" aria-hidden="true">
                  <svg class="w-4 h-4 text-primary-700 dark:text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                  </svg>
                </div>
              </div>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                <%= @current_date.strftime('%B %Y') %>
              </p>
            </header>

            <!-- Category List -->
            <div class="flex-1">
              <% if @category_breakdown.any? %>
                <div class="space-y-2">
                  <% @category_breakdown.sort_by { |_, amount| -amount }.first(3).each do |category, amount| %>
                    <div class="flex items-center justify-between p-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                      <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-primary-500"></div>
                        <span class="text-sm font-medium text-gray-900 dark:text-white truncate">
                          <%= truncate(category&.humanize || "Uncategorized", length: 15) %>
                        </span>
                      </div>
                      <span class="text-sm font-semibold <%= amount < 0 ? 'text-expense-500 dark:text-expense-400' : 'text-income-500 dark:text-income-400' %>">
                        $<%= number_with_precision(amount.abs, precision: 0) %>
                      </span>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <div class="flex items-center justify-center h-full">
                  <p class="text-xs text-gray-500 dark:text-gray-400 text-center">No data</p>
                </div>
              <% end %>
            </div>
          </div>
        </article>

        <!-- Top Merchants Card (1x1) -->
        <article class="bento-span-1 bento-row-span-1 bg-gradient-to-br from-neutral-100 to-white dark:from-primary-700 dark:to-primary-900 rounded-2xl shadow-lg p-6 border-2 border-primary-700/20 dark:border-primary-900/30">
          <div class="flex flex-col h-full">
            <!-- Header -->
            <header class="mb-4">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Top Merchants</h3>
                <div class="inline-flex items-center justify-center w-8 h-8 bg-primary-700/10 dark:bg-primary-500/20 rounded-lg" aria-hidden="true">
                  <svg class="w-4 h-4 text-primary-700 dark:text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                </div>
              </div>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                This month
              </p>
            </header>

            <!-- Merchant List -->
            <div class="flex-1">
              <% if @merchant_breakdown.any? %>
                <div class="space-y-2">
                  <% @merchant_breakdown.first(3).each_with_index do |(merchant, amount), index| %>
                    <div class="flex items-center justify-between p-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                      <div class="flex items-center gap-2">
                        <div class="flex items-center justify-center w-6 h-6 bg-primary-100 dark:bg-primary-900/30 rounded-full">
                          <span class="text-xs font-bold text-primary-700 dark:text-primary-400">#<%= index + 1 %></span>
                        </div>
                        <span class="text-sm font-medium text-gray-900 dark:text-white truncate">
                          <%= truncate(merchant, length: 12) %>
                        </span>
                      </div>
                      <span class="text-sm font-semibold text-expense-500 dark:text-expense-400">
                        $<%= number_with_precision(amount.abs, precision: 0) %>
                      </span>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <div class="flex items-center justify-center h-full">
                  <p class="text-xs text-gray-500 dark:text-gray-400 text-center">No data</p>
                </div>
              <% end %>
            </div>
          </div>
        </article>

      </section>

      <!-- Detailed Analysis Section -->
      <section aria-labelledby="detailed-analysis-heading" class="bg-gradient-to-br from-neutral-100 to-white dark:from-gray-800 dark:to-gray-900 rounded-2xl shadow-lg border-2 border-gray-200 dark:border-gray-700">
        <header class="px-6 py-5 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between bg-gray-50 dark:bg-gray-800">
          <div>
            <h2 id="detailed-analysis-heading" class="text-2xl font-bold text-gray-900 dark:text-white">Detailed Analysis</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Interactive charts and detailed breakdowns</p>
          </div>
          <div class="flex gap-3">
            <!-- Filter Dropdown -->
            <div class="relative flex items-center gap-2">
              <select id="analysis-filter" name="filter" 
                      class="block px-4 py-2 pr-10 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent cursor-pointer">
                <option value="categories">Categories</option>
                <option value="merchants">Merchants</option>
                <option value="trends">Trends</option>
                <% if @custom_filters.any? %>
                  <optgroup label="Custom Filters">
                    <% @custom_filters.each do |filter| %>
                      <option value="custom_<%= filter.id %>" <%= 'selected' if params[:filter_id].to_s == filter.id.to_s %>><%= filter.name %></option>
                    <% end %>
                  </optgroup>
                <% end %>
              </select>
              
              <!-- Edit Filter Button (hidden by default, shown when custom filter selected) -->
              <button type="button" id="edit-filter-btn" 
                      class="hidden items-center px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors focus:ring-2 focus:ring-blue-400 focus:outline-none"
                      title="Edit selected filter"
                      aria-label="Edit selected filter">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
              </button>
              
              <!-- Delete Filter Button (hidden by default, shown when custom filter selected) -->
              <button type="button" id="delete-filter-btn" 
                      class="hidden items-center px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors focus:ring-2 focus:ring-red-400 focus:outline-none"
                      title="Delete selected filter"
                      aria-label="Delete selected filter">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
            
            <!-- Create Filter Button -->
            <button type="button" 
                    data-action="click->modal#open" 
                    class="inline-flex items-center px-4 py-2 bg-primary-700 text-white rounded-lg hover:bg-primary-900 transition-colors focus:ring-2 focus:ring-primary-400 focus:outline-none"
                    aria-label="Create new filter">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              Create Filter
            </button>
            
            <!-- View Toggle -->
            <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
              <button id="pie-chart-btn" class="px-3 py-1 text-xs font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                Pie Chart
              </button>
              <button id="bar-chart-btn" class="px-3 py-1 text-xs font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                Bar Chart
              </button>
              <button id="table-btn" class="px-3 py-1 text-xs font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                Line Chart
              </button>
            </div>
          </div>
        </div>

        <!-- Chart Content -->
        <div class="p-8">
          <!-- Pie Chart View -->
          <div id="pie-chart-view" class="chart-view">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Spending Breakdown</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">
                <%= @selected_filter ? @selected_filter.name : @current_date.strftime('%B %Y') %>
              </p>
            </div>
            
            
            <!-- Total Amount Display -->
            <div class="text-center mb-6">
              <div class="text-3xl font-bold text-gray-900 dark:text-white">
                $<%= number_with_precision(@breakdown_data.values.sum(&:abs), precision: 0) %>
              </div>
              <div class="text-sm text-gray-500 dark:text-gray-400">Total Amount</div>
            </div>
            
            <div class="flex items-center justify-center gap-8">
              <div class="relative flex-1 flex justify-center" style="min-width: 400px;">
                <!-- ApexCharts Pie Chart -->
                <% 
                  colors = ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6B7280']
                  
                  # Prepare data for ApexCharts - pie charts expect series as array of values
                  chart_series = []
                  chart_labels = []
                  
                  # Sort by absolute value to get the largest items
                  sorted_data = @breakdown_data.sort_by { |_, amount| -amount.abs }.first(6)
                  
                  sorted_data.each do |item, amount|
                    abs_amount = amount.abs
                    # Only add if the absolute amount is greater than 0
                    if abs_amount > 0
                      chart_series << abs_amount
                      chart_labels << (item&.humanize || item || 'Uncategorized')
                    end
                  end
                  
                  # Calculate total for display
                  total_amount = chart_series.sum
                %>
                
                <% if chart_series.any? && chart_series.sum > 0 %>
                  <div 
                    data-controller="chart"
                    data-chart-type-value="pie"
                    data-chart-series-value="<%= chart_series.to_json %>"
                    data-chart-labels-value="<%= chart_labels.to_json %>"
                    data-chart-colors-value="<%= colors.to_json %>"
                    data-chart-height-value="400"
                    class="w-full max-w-lg h-96 sm:h-80 lg:h-96"
                    style="min-height: 400px;"
                  ></div>
                <% else %>
                  <div class="flex items-center justify-center w-full max-w-lg h-96 sm:h-80 lg:h-96 text-gray-500 dark:text-gray-400">
                    <div class="text-center">
                      <p class="text-lg font-semibold mb-2">No data available</p>
                      <p class="text-sm">Please select a filter or sync your transactions</p>
                    </div>
                  </div>
                <% end %>
              </div>
              
              <!-- Multiple Breakdown Sections -->
              <div class="flex flex-col gap-4 w-fit">
                <!-- Date Range Card -->
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700 w-fit min-w-0">
                  <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-2 flex items-center gap-2 whitespace-nowrap">
                    <svg class="w-4 h-4 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Date Range
                  </h4>
                  <div class="text-xs text-gray-600 dark:text-gray-400 whitespace-nowrap">
                    <% if @selected_filter&.date_range.present? %>
                      <% if @selected_filter.date_range['type'] == 'custom' %>
                        <%= @selected_filter.date_range['start_date'] %> to <%= @selected_filter.date_range['end_date'] %>
                      <% else %>
                        <%= @selected_filter.date_range['type'].humanize %>
                      <% end %>
                    <% else %>
                      <%= @current_date.strftime('%B %Y') %>
                    <% end %>
                  </div>
                </div>
                
                <% @all_breakdowns.each do |breakdown_type, breakdown_data| %>
                  <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700 w-fit min-w-0">
                    <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-2 flex items-center gap-2 whitespace-nowrap">
                      <% case breakdown_type %>
                      <% when 'category' %>
                        <svg class="w-4 h-4 text-primary-700 dark:text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                      <% when 'merchant' %>
                        <svg class="w-4 h-4 text-primary-700 dark:text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                      <% when 'status' %>
                        <svg class="w-4 h-4 text-primary-700 dark:text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                      <% end %>
                      Top <%= breakdown_type.capitalize %>
                    </h4>
                    <div class="space-y-1 w-fit">
                      <% if breakdown_data.any? %>
                        <% breakdown_data.first(4).each_with_index do |(item, amount), index| %>
                          <% 
                            section_total = breakdown_data.values.sum(&:abs)
                            percentage = section_total > 0 ? (amount.abs / section_total.to_f) * 100 : 0
                          %>
                          <div class="flex items-center gap-2 p-1.5 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors w-fit">
                            <div class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background-color: <%= colors[index % colors.length] %>"></div>
                            <div class="min-w-0">
                              <div class="text-xs font-medium text-gray-900 dark:text-white whitespace-nowrap">
                                <%= item&.humanize || item || "Uncategorized" %>
                        </div>
                              <div class="text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap">
                          <%= percentage.round(1) %>% • $<%= number_with_precision(amount.abs, precision: 0) %>
                        </div>
                      </div>
                    </div>
                        <% end %>
                      <% else %>
                        <p class="text-xs text-gray-500 dark:text-gray-400 italic">No data</p>
                      <% end %>
                </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
          
          <!-- Bar Chart View -->
          <div id="bar-chart-view" class="chart-view hidden">
            <!-- Total Amount Display -->
            <div class="text-center mb-6">
              <div class="text-3xl font-bold text-gray-900 dark:text-white">
                $<%= number_with_precision(@breakdown_data.values.sum(&:abs), precision: 0) %>
              </div>
              <div class="text-sm text-gray-500 dark:text-gray-400">Total Amount</div>
            </div>
            
            <div class="flex items-center justify-center gap-8">
              <div class="relative flex-1 flex justify-center">
                <!-- ApexCharts Bar Chart -->
                <% 
                  colors = ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6B7280']
                  total_amount = @breakdown_data.values.sum(&:abs)
                  
                  # Prepare data for ApexCharts - bar charts expect series as array of objects with data property
                  chart_series = []
                  chart_labels = []
                  
                  if total_amount > 0
                    @breakdown_data.first(8).each_with_index do |(item, amount), index|
                      chart_series << amount.abs
                      chart_labels << (item&.humanize || item || 'Uncategorized')
                    end
                  end
                %>
                
                <div 
                  data-controller="chart"
                  data-chart-type-value="bar"
                  data-chart-series-value="<%= chart_series.to_json %>"
                  data-chart-labels-value="<%= chart_labels.to_json %>"
                  data-chart-colors-value="<%= colors.to_json %>"
                  data-chart-height-value="400"
                  class="w-full max-w-2xl h-96 sm:h-80 lg:h-96"
                  style="min-height: 400px;"
                ></div>
              </div>
              
              <!-- Multiple Breakdown Sections -->
              <div class="flex flex-col gap-4 w-fit">
                <!-- Date Range Card -->
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700 w-fit min-w-0">
                  <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-2 flex items-center gap-2 whitespace-nowrap">
                    <svg class="w-4 h-4 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Date Range
                  </h4>
                  <div class="text-xs text-gray-600 dark:text-gray-400 whitespace-nowrap">
                    <% if @selected_filter&.date_range.present? %>
                      <% if @selected_filter.date_range['type'] == 'custom' %>
                        <%= @selected_filter.date_range['start_date'] %> to <%= @selected_filter.date_range['end_date'] %>
                      <% else %>
                        <%= @selected_filter.date_range['type'].humanize %>
                      <% end %>
                    <% else %>
                      <%= @current_date.strftime('%B %Y') %>
                    <% end %>
                  </div>
                </div>
                
                <% @all_breakdowns.each do |breakdown_type, breakdown_data| %>
                  <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700 w-fit min-w-0">
                    <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-2 flex items-center gap-2 whitespace-nowrap">
                      <% case breakdown_type %>
                      <% when 'category' %>
                        <svg class="w-4 h-4 text-primary-700 dark:text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                      <% when 'merchant' %>
                        <svg class="w-4 h-4 text-primary-700 dark:text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                      <% when 'status' %>
                        <svg class="w-4 h-4 text-primary-700 dark:text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                      <% end %>
                      Top <%= breakdown_type.capitalize %>
                    </h4>
                    <div class="space-y-1 w-fit">
                      <% if breakdown_data.any? %>
                        <% breakdown_data.first(4).each_with_index do |(item, amount), index| %>
                          <% 
                            section_total = breakdown_data.values.sum(&:abs)
                            percentage = section_total > 0 ? (amount.abs / section_total.to_f) * 100 : 0
                          %>
                          <div class="flex items-center gap-2 p-1.5 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors w-fit">
                            <div class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background-color: <%= colors[index % colors.length] %>"></div>
                            <div class="min-w-0">
                              <div class="text-xs font-medium text-gray-900 dark:text-white whitespace-nowrap">
                                <%= item&.humanize || item || "Uncategorized" %>
                              </div>
                              <div class="text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap">
                                <%= percentage.round(1) %>% • $<%= number_with_precision(amount.abs, precision: 0) %>
                              </div>
                            </div>
                          </div>
                        <% end %>
                      <% else %>
                        <p class="text-xs text-gray-500 dark:text-gray-400 italic">No data</p>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
          
          <!-- Line Chart View -->
          <div id="line-chart-view" class="chart-view hidden">
            <!-- Total Amount Display -->
            <div class="text-center mb-6">
              <div class="text-3xl font-bold text-gray-900 dark:text-white">
                $<%= number_with_precision(@breakdown_data.values.sum(&:abs), precision: 0) %>
              </div>
              <div class="text-sm text-gray-500 dark:text-gray-400">Total Amount</div>
            </div>
            
            <div class="flex items-center justify-center gap-8">
              <div class="relative flex-1 flex justify-center">
                <!-- ApexCharts Line Chart -->
                <% 
                  colors = ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6B7280']
                  total_amount = @breakdown_data.values.sum(&:abs)
                  
                  # Prepare data for ApexCharts - line charts expect series as array of objects with data property
                  chart_series = []
                  chart_labels = []
                  
                  if total_amount > 0
                    @breakdown_data.first(8).each_with_index do |(item, amount), index|
                      chart_series << amount.abs
                      chart_labels << (item&.humanize || item || 'Uncategorized')
                    end
                  end
                %>
                
                <div 
                  data-controller="chart"
                  data-chart-type-value="line"
                  data-chart-series-value="<%= chart_series.to_json %>"
                  data-chart-labels-value="<%= chart_labels.to_json %>"
                  data-chart-colors-value="<%= colors.to_json %>"
                  data-chart-height-value="400"
                  class="w-full max-w-2xl h-96 sm:h-80 lg:h-96"
                  style="min-height: 400px;"
                ></div>
              </div>
              
              <!-- Multiple Breakdown Sections -->
              <div class="flex flex-col gap-4 w-fit">
                <!-- Date Range Card -->
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700 w-fit min-w-0">
                  <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-2 flex items-center gap-2 whitespace-nowrap">
                    <svg class="w-4 h-4 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Date Range
                  </h4>
                  <div class="text-xs text-gray-600 dark:text-gray-400 whitespace-nowrap">
                    <% if @selected_filter&.date_range.present? %>
                      <% if @selected_filter.date_range['type'] == 'custom' %>
                        <%= @selected_filter.date_range['start_date'] %> to <%= @selected_filter.date_range['end_date'] %>
                      <% else %>
                        <%= @selected_filter.date_range['type'].humanize %>
                      <% end %>
                    <% else %>
                      <%= @current_date.strftime('%B %Y') %>
                    <% end %>
                  </div>
                </div>
                
                <% @all_breakdowns.each do |breakdown_type, breakdown_data| %>
                  <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700 w-fit min-w-0">
                    <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-2 flex items-center gap-2 whitespace-nowrap">
                      <% case breakdown_type %>
                      <% when 'category' %>
                        <svg class="w-4 h-4 text-primary-700 dark:text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                      <% when 'merchant' %>
                        <svg class="w-4 h-4 text-primary-700 dark:text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                      <% when 'status' %>
                        <svg class="w-4 h-4 text-primary-700 dark:text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                      <% end %>
                      Top <%= breakdown_type.capitalize %>
                    </h4>
                    <div class="space-y-1 w-fit">
                      <% if breakdown_data.any? %>
                        <% breakdown_data.first(4).each_with_index do |(item, amount), index| %>
                          <% 
                            section_total = breakdown_data.values.sum(&:abs)
                            percentage = section_total > 0 ? (amount.abs / section_total.to_f) * 100 : 0
                          %>
                          <div class="flex items-center gap-2 p-1.5 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors w-fit">
                            <div class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background-color: <%= colors[index % colors.length] %>"></div>
                            <div class="min-w-0">
                              <div class="text-xs font-medium text-gray-900 dark:text-white whitespace-nowrap">
                                <%= item&.humanize || item || "Uncategorized" %>
                              </div>
                              <div class="text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap">
                                <%= percentage.round(1) %>% • $<%= number_with_precision(amount.abs, precision: 0) %>
                              </div>
                            </div>
                          </div>
                        <% end %>
                      <% else %>
                        <p class="text-xs text-gray-500 dark:text-gray-400 italic">No data</p>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Additional Analysis Coming Soon -->
      <section class="mt-8 bg-gradient-to-br from-neutral-100 to-white dark:from-primary-700 dark:to-primary-900 rounded-2xl shadow-lg p-6 border-2 border-success-500/20 dark:border-success-700/30">
        <div class="text-center">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-success-500/10 dark:bg-success-700/20 rounded-2xl mb-4" aria-hidden="true">
            <svg class="w-8 h-8 text-success-500 dark:text-success-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
          </div>
          <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2">More Analysis Features Coming Soon</h2>
          <p class="text-gray-600 dark:text-gray-400 mb-4">
            We're working on adding more advanced analytics including trend charts, spending patterns, and predictive insights.
          </p>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm text-gray-600 dark:text-gray-400">
            <div class="flex items-center justify-center gap-2">
              <svg class="w-4 h-4 text-success-500 dark:text-success-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Trend Charts</span>
            </div>
            <div class="flex items-center justify-center gap-2">
              <svg class="w-4 h-4 text-success-500 dark:text-success-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Spending Patterns</span>
            </div>
            <div class="flex items-center justify-center gap-2">
              <svg class="w-4 h-4 text-success-500 dark:text-success-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Predictive Insights</span>
            </div>
          </div>
        </div>
      </section>

    <% else %>
      <!-- No Account Message -->
      <div class="bg-gradient-to-br from-neutral-100 to-white dark:from-primary-700 dark:to-primary-900 rounded-lg shadow-sm border-2 border-primary-700/30 dark:border-primary-900/30 p-12 text-center">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">No account found</h2>
        <p class="text-gray-600 dark:text-gray-400">Please sync your Up Bank account first.</p>
        <%= link_to "Go to Settings", settings_path, class: "inline-flex items-center mt-4 px-6 py-3 bg-primary-700 text-white rounded-lg hover:bg-primary-900 transition-colors" %>
      </div>
    <% end %>
  </div>
</main>

<!-- Filter Drawer (Slide-in Panel) -->
<div id="filterModal" 
     data-modal-target="modal"
     class="fixed inset-0 z-50 hidden">
  
  <!-- Drawer Panel (slides in from right - responsive width) -->
  <div class="absolute inset-y-0 right-0 w-full sm:w-96 bg-white dark:bg-primary-700 shadow-2xl flex flex-col transform translate-x-full transition-transform duration-500 ease-in-out border-l-2 border-gray-300 dark:border-gray-700 md:top-16 md:bottom-0"
       data-modal-target="drawer">
    
    <!-- Drawer Header -->
    <div class="bg-gradient-to-r from-primary-500 via-primary-700 to-primary-500 dark:from-primary-700 dark:via-primary-900 dark:to-primary-700 px-6 py-5 flex-shrink-0">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="inline-flex items-center justify-center w-10 h-10 bg-white/20 rounded-lg">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z" />
            </svg>
          </div>
          <div>
            <h3 id="filter-modal-title" class="text-xl font-bold text-white">Create Custom Filter</h3>
            <p class="text-white/80 text-sm mt-0.5">Set up personalized data filters</p>
          </div>
        </div>
        <button type="button" 
                data-action="click->modal#close" 
                class="text-white/70 hover:text-white hover:bg-white/10 rounded-lg p-2 transition-all focus:ring-2 focus:ring-white/50 focus:outline-none"
                aria-label="Close filter modal">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Drawer Content (Scrollable) -->
    <div class="flex-1 overflow-y-auto">
      <form id="filter-form" class="p-6" data-modal-target="form">
        <div class="space-y-5">
          <!-- Filter Name -->
          <div>
            <label for="filter-name" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Filter Name</label>
            <input type="text" id="filter-name" name="name" required
                   class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-primary-900 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-primary-700 focus:border-primary-700 dark:focus:border-primary-500 transition-all"
                   placeholder="e.g., High Value Expenses">
          </div>
          
          <!-- Filter Types Selection -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">Filter Types</label>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Select one or more filter types to combine</p>
            <div class="grid grid-cols-2 gap-2">
              <label class="filter-type-label flex items-center p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-primary-900 transition-all">
                <input type="checkbox" name="filter_types[]" value="category" class="mr-2">
                <span class="text-sm text-gray-700 dark:text-gray-300">Category</span>
              </label>
              <label class="filter-type-label flex items-center p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-primary-900 transition-all">
                <input type="checkbox" name="filter_types[]" value="merchant" class="mr-2">
                <span class="text-sm text-gray-700 dark:text-gray-300">Merchant</span>
              </label>
              <label class="filter-type-label flex items-center p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-primary-900 transition-all">
                <input type="checkbox" name="filter_types[]" value="status" class="mr-2">
                <span class="text-sm text-gray-700 dark:text-gray-300">Status</span>
              </label>
              <label class="filter-type-label flex items-center p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-primary-900 transition-all">
                <input type="checkbox" name="filter_types[]" value="recurring_transactions" class="mr-2">
                <span class="text-sm text-gray-700 dark:text-gray-300">Recurring</span>
              </label>
            </div>
          </div>
          
          <!-- Filter Parameters (Dynamic based on selected types) -->
          <div id="filter-params" class="space-y-4">
            <!-- This will be populated dynamically based on selected filter types -->
          </div>
          
          <!-- Date Range Selection -->
          <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-3">Date Range</label>
            <div class="grid grid-cols-2 gap-2 mb-4">
              <label class="date-range-label flex items-center p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-primary-900 transition-all">
                <input type="radio" name="date_range" value="today" class="mr-2">
                <span class="text-sm text-gray-700 dark:text-gray-300">Today</span>
              </label>
              <label class="date-range-label flex items-center p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-primary-900 transition-all">
                <input type="radio" name="date_range" value="current_week" class="mr-2">
                <span class="text-sm text-gray-700 dark:text-gray-300">Current Week</span>
              </label>
              <label class="date-range-label flex items-center p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-primary-900 transition-all">
                <input type="radio" name="date_range" value="current_month" class="mr-2">
                <span class="text-sm text-gray-700 dark:text-gray-300">Current Month</span>
              </label>
              <label class="date-range-label flex items-center p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-primary-900 transition-all">
                <input type="radio" name="date_range" value="last_month" class="mr-2">
                <span class="text-sm text-gray-700 dark:text-gray-300">Last Month</span>
              </label>
              <label class="date-range-label flex items-center p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-primary-900 transition-all">
                <input type="radio" name="date_range" value="3_months" class="mr-2">
                <span class="text-sm text-gray-700 dark:text-gray-300">3 Months</span>
              </label>
              <label class="date-range-label flex items-center p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-primary-900 transition-all">
                <input type="radio" name="date_range" value="6_months" class="mr-2">
                <span class="text-sm text-gray-700 dark:text-gray-300">6 Months</span>
              </label>
              <label class="date-range-label flex items-center p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-primary-900 transition-all">
                <input type="radio" name="date_range" value="current_year" class="mr-2">
                <span class="text-sm text-gray-700 dark:text-gray-300">Current Year</span>
              </label>
              <label class="date-range-label flex items-center p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-primary-900 transition-all">
                <input type="radio" name="date_range" value="custom" class="mr-2">
                <span class="text-sm text-gray-700 dark:text-gray-300">Custom Range</span>
              </label>
            </div>
            
            <!-- Custom Date Range Inputs (shown when "Custom Range" is selected) -->
            <div id="custom-date-range" class="hidden">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Start Date</label>
                  <input type="date" name="custom_start_date" id="custom_start_date"
                         class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">End Date</label>
                  <input type="date" name="custom_end_date" id="custom_end_date"
                         class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Drawer Footer (Sticky at bottom) -->
        <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
          <div class="flex gap-3">
            <button type="submit" id="submit-filter-btn" class="flex-1 bg-gradient-to-r from-primary-700 to-primary-500 dark:from-primary-700 dark:to-primary-900 hover:from-primary-900 hover:to-primary-700 text-white px-5 py-3 rounded-lg font-semibold shadow-md hover:shadow-lg transition-all">
              Save Filter
            </button>
            <button type="button" 
                    data-action="click->modal#close" 
                    class="px-5 py-3 bg-white dark:bg-primary-950 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-primary-900 font-semibold transition-all">
              Cancel
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Initialize filter dropdown functionality
function initializeFilterDropdown() {
  // Available filter options from database
  const availableCategories = <%= raw @available_categories.to_json %>;
  const availableMerchants = <%= raw @available_merchants.to_json %>;
  const availableStatuses = <%= raw @available_statuses.to_json %>;
  const merchantCategories = <%= raw @merchant_categories.to_json %>;
  const merchantStatuses = <%= raw @merchant_statuses.to_json %>;
  const categoryStatuses = <%= raw @category_statuses.to_json %>;
  const statusMerchants = <%= raw @status_merchants.to_json %>;
  const statusCategories = <%= raw @status_categories.to_json %>;
  
  // Filter dropdown change handler
  const filterDropdown = document.getElementById('analysis-filter');
  const editFilterBtn = document.getElementById('edit-filter-btn');
  const deleteFilterBtn = document.getElementById('delete-filter-btn');
  
  // Return early if elements don't exist or already initialized
  if (!filterDropdown || !editFilterBtn || !deleteFilterBtn || filterDropdown.dataset.initialized === 'true') {
    return;
  }
  
  // Mark as initialized
  filterDropdown.dataset.initialized = 'true';
  
  function updateButtonVisibility() {
    if (filterDropdown && editFilterBtn && deleteFilterBtn) {
      const filterValue = filterDropdown.value;
      if (filterValue.startsWith('custom_')) {
        editFilterBtn.classList.remove('hidden');
        editFilterBtn.classList.add('inline-flex');
        deleteFilterBtn.classList.remove('hidden');
        deleteFilterBtn.classList.add('inline-flex');
      } else {
        editFilterBtn.classList.add('hidden');
        editFilterBtn.classList.remove('inline-flex');
        deleteFilterBtn.classList.add('hidden');
        deleteFilterBtn.classList.remove('inline-flex');
      }
    }
  }
  
  if (filterDropdown) {
    filterDropdown.addEventListener('change', function() {
      const filterValue = this.value;
      
      // Update button visibility
      updateButtonVisibility();
      
      // Build URL with filter parameter
      let url = '/analysis';
      if (filterValue.startsWith('custom_')) {
        const filterId = filterValue.replace('custom_', '');
        url += '?filter_id=' + filterId;
      }
      
      // Navigate to filtered view using Turbo
      Turbo.visit(url);
    });
  }
  
  // Initial button visibility check
  updateButtonVisibility();
  
  // Store filter data for editing
  const filterDataMap = {};
  <% @custom_filters.each do |filter| %>
    filterDataMap[<%= filter.id %>] = {
      name: <%= raw filter.name.to_json %>,
      filter_types: <%= raw filter.filter_types.to_json %>,
      filter_params: <%= raw filter.filter_params.to_json %>,
      date_range: <%= raw filter.date_range.to_json %>
    };
  <% end %>
  
  // Edit filter button handler
  if (editFilterBtn) {
    editFilterBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const filterValue = filterDropdown.value;
      
      if (!filterValue.startsWith('custom_')) {
        return;
      }
      
      const filterId = filterValue.replace('custom_', '');
      const filterData = filterDataMap[filterId];
      
      if (!filterData) {
        alert('Filter data not found');
        return;
      }
      
      // Populate the form with existing data
      populateFilterForm(filterData, filterId);
      
      // Open the modal
      const modalElement = document.querySelector('[data-modal-target="modal"]');
      if (modalElement) {
        modalElement.classList.remove('hidden');
        const drawer = modalElement.querySelector('[data-modal-target="drawer"]');
        if (drawer) {
          drawer.classList.remove('translate-x-full');
        }
      }
    });
  }
  
  // Function to populate filter form
  function populateFilterForm(filterData, filterId) {
    // Set the form mode
    const form = document.getElementById('filter-form');
    form.dataset.mode = 'edit';
    form.dataset.filterId = filterId;
    
    // Update modal title
    const modalTitle = document.getElementById('filter-modal-title');
    if (modalTitle) {
      modalTitle.textContent = 'Edit Custom Filter';
    }
    
    // Update submit button text
    const submitBtn = document.getElementById('submit-filter-btn');
    if (submitBtn) {
      submitBtn.textContent = 'Update Filter';
    }
    
    // Set the filter name
    document.getElementById('filter-name').value = filterData.name || '';
    
    // Check the filter type checkboxes
    const filterTypeCheckboxes = document.querySelectorAll('input[name="filter_types[]"]');
    filterTypeCheckboxes.forEach(checkbox => {
      checkbox.checked = filterData.filter_types && filterData.filter_types.includes(checkbox.value);
    });
    
    // Trigger the change event to populate filter parameters
    filterTypeCheckboxes.forEach(checkbox => {
      if (checkbox.checked) {
        checkbox.dispatchEvent(new Event('change'));
      }
    });
    
    // Populate filter parameters based on types
    setTimeout(() => {
      filterData.filter_types.forEach(type => {
        if (type === 'category' && filterData.filter_params.categories) {
          filterData.filter_params.categories.forEach(cat => {
            const checkbox = document.querySelector(`input[name="filter_params[categories][]"][value="${cat}"]`);
            if (checkbox) checkbox.checked = true;
          });
        } else if (type === 'merchant' && filterData.filter_params.merchants) {
          filterData.filter_params.merchants.forEach(merchant => {
            const checkbox = document.querySelector(`input[name="filter_params[merchants][]"][value="${merchant}"]`);
            if (checkbox) checkbox.checked = true;
          });
        } else if (type === 'status' && filterData.filter_params.statuses) {
          filterData.filter_params.statuses.forEach(status => {
            const checkbox = document.querySelector(`input[name="filter_params[statuses][]"][value="${status}"]`);
            if (checkbox) checkbox.checked = true;
          });
        } else if (type === 'recurring_transactions' && filterData.filter_params.recurring_transactions) {
          const radio = document.querySelector(`input[name="filter_params[recurring_transactions]"][value="${filterData.filter_params.recurring_transactions}"]`);
          if (radio) radio.checked = true;
        }
      });
      
      // Populate date range
      if (filterData.date_range && filterData.date_range.type) {
        const dateRadio = document.querySelector(`input[name="date_range"][value="${filterData.date_range.type}"]`);
        if (dateRadio) {
          dateRadio.checked = true;
          dateRadio.dispatchEvent(new Event('change'));
          
          if (filterData.date_range.type === 'custom') {
            if (filterData.date_range.start_date) {
              document.getElementById('custom_start_date').value = filterData.date_range.start_date;
            }
            if (filterData.date_range.end_date) {
              document.getElementById('custom_end_date').value = filterData.date_range.end_date;
            }
          }
        }
      }
    }, 100);
  }
  
  // Function to reset filter form to create mode
  function resetFilterForm() {
    const form = document.getElementById('filter-form');
    if (form) {
      form.dataset.mode = 'create';
      form.dataset.filterId = '';
      form.reset();
      
      // Reset modal title
      const modalTitle = document.getElementById('filter-modal-title');
      if (modalTitle) {
        modalTitle.textContent = 'Create Custom Filter';
      }
      
      // Reset submit button text
      const submitBtn = document.getElementById('submit-filter-btn');
      if (submitBtn) {
        submitBtn.textContent = 'Save Filter';
      }
      
      // Clear filter parameters
      const filterParamsDiv = document.getElementById('filter-params');
      if (filterParamsDiv) {
        filterParamsDiv.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 italic">Select at least one filter type above</p>';
      }
      
      // Hide custom date range
      const customDateRangeDiv = document.getElementById('custom-date-range');
      if (customDateRangeDiv) {
        customDateRangeDiv.classList.add('hidden');
      }
      
      // Reset button states
      const filterTypeCheckboxes = document.querySelectorAll('input[name="filter_types[]"]');
      filterTypeCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
        const label = checkbox.closest('.filter-type-label');
        if (label) {
          label.classList.remove('bg-primary-100', 'dark:bg-primary-900', 'border-primary-500', 'dark:border-primary-500');
          label.classList.add('border-gray-200', 'dark:border-gray-600');
        }
      });
      
      // Reset date range buttons
      const dateRangeRadios = document.querySelectorAll('input[name="date_range"]');
      dateRangeRadios.forEach(radio => {
        radio.checked = false;
        const label = radio.closest('.date-range-label');
        if (label) {
          label.classList.remove('bg-primary-100', 'dark:bg-primary-900', 'border-primary-500', 'dark:border-primary-500');
          label.classList.add('border-gray-200', 'dark:border-gray-600');
        }
      });
    }
  }
  
  // Reset form when modal opens for create
  const createFilterBtn = document.querySelector('[data-action="click->modal#open"]');
  if (createFilterBtn) {
    createFilterBtn.addEventListener('click', function() {
      resetFilterForm();
    });
  }
  
  // Reset form when modal closes
  const closeModalBtns = document.querySelectorAll('[data-action="click->modal#close"]');
  closeModalBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      setTimeout(resetFilterForm, 500); // Delay to allow close animation
    });
  });
  
  // Delete filter button handler
  if (deleteFilterBtn) {
    deleteFilterBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const filterValue = filterDropdown.value;
      
      if (!filterValue.startsWith('custom_')) {
        return;
      }
      
      const filterId = filterValue.replace('custom_', '');
      
      // Confirm deletion
      if (!confirm('Are you sure you want to delete this filter?')) {
        return;
      }
      
      // Delete the filter
      fetch(`/filters/${filterId}`, {
        method: 'DELETE',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
      })
      .then(response => {
        if (response.ok || response.status === 404) {
          // Reload the page to update the filter list (even if already deleted)
          Turbo.visit('/analysis');
        } else {
          return response.text().then(text => {
            throw new Error(`Server error: ${response.status}`);
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error deleting filter: ' + error.message);
      });
    });
  }
  
  // View toggle functionality
  const pieChartBtn = document.getElementById('pie-chart-btn');
  const barChartBtn = document.getElementById('bar-chart-btn');
  const tableBtn = document.getElementById('table-btn');
  
  const pieChartView = document.getElementById('pie-chart-view');
  const barChartView = document.getElementById('bar-chart-view');
  const lineChartView = document.getElementById('line-chart-view');
  
  function showView(viewElement, activeBtn) {
    // Hide all views
    pieChartView.classList.add('hidden');
    barChartView.classList.add('hidden');
    lineChartView.classList.add('hidden');
    
    // Remove active state from all buttons
    pieChartBtn.classList.remove('bg-white', 'dark:bg-gray-800', 'shadow-sm');
    pieChartBtn.classList.add('text-gray-500', 'dark:text-gray-400');
    pieChartBtn.classList.remove('text-gray-700', 'dark:text-gray-300');
    
    barChartBtn.classList.remove('bg-white', 'dark:bg-gray-800', 'shadow-sm');
    barChartBtn.classList.add('text-gray-500', 'dark:text-gray-400');
    barChartBtn.classList.remove('text-gray-700', 'dark:text-gray-300');
    
    tableBtn.classList.remove('bg-white', 'dark:bg-gray-800', 'shadow-sm');
    tableBtn.classList.add('text-gray-500', 'dark:text-gray-400');
    tableBtn.classList.remove('text-gray-700', 'dark:text-gray-300');
    
    // Show selected view
    viewElement.classList.remove('hidden');
    
    // Set active state on button
    activeBtn.classList.add('bg-white', 'dark:bg-gray-800', 'shadow-sm');
    activeBtn.classList.add('text-gray-700', 'dark:text-gray-300');
    activeBtn.classList.remove('text-gray-500', 'dark:text-gray-400');
  }
  
  pieChartBtn.addEventListener('click', function() {
    showView(pieChartView, pieChartBtn);
  });
  
  barChartBtn.addEventListener('click', function() {
    showView(barChartView, barChartBtn);
  });
  
  tableBtn.addEventListener('click', function() {
    showView(lineChartView, tableBtn);
  });
  
  // Pie chart hover effects
  const pieSlices = document.querySelectorAll('.pie-slice');
  pieSlices.forEach(slice => {
    slice.addEventListener('mouseenter', function() {
      const category = this.dataset.category;
      const amount = this.dataset.amount;
      const percentage = this.dataset.percentage;
      
      // Create tooltip
      const tooltip = document.createElement('div');
      tooltip.className = 'absolute bg-gray-900 text-white px-3 py-2 rounded-lg text-sm pointer-events-none z-10';
      tooltip.innerHTML = `
        <div class="font-semibold">${category}</div>
        <div>$${parseFloat(amount).toLocaleString()} (${percentage}%)</div>
      `;
      
      document.body.appendChild(tooltip);
      
      // Position tooltip
      const rect = this.getBoundingClientRect();
      tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
      tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
      
      this.tooltip = tooltip;
    });
    
    slice.addEventListener('mouseleave', function() {
      if (this.tooltip) {
        this.tooltip.remove();
        this.tooltip = null;
      }
    });
  });
  
  // Filter type change handler - now handles multiple selections
  const filterCheckboxes = document.querySelectorAll('input[name="filter_types[]"]');
  const filterParamsDiv = document.getElementById('filter-params');
  
  // Render parameters for a specific filter type with dynamic filtering based on all selected params
  function renderFilterParams(filterType, selectedParams = {}) {
    let html = '';
    const selectedCategories = selectedParams.categories || [];
    const selectedStatuses = selectedParams.statuses || [];
    const selectedMerchants = selectedParams.merchants || [];
    
    console.log(`Rendering ${filterType} with selected params:`, selectedParams);
    
    if (filterType === 'category') {
      // Filter categories based on selected merchants and statuses
      let filteredCategories = availableCategories;
      
      if (selectedMerchants.length > 0) {
        filteredCategories = filteredCategories.filter(cat => {
          // Always include already selected categories
          if (selectedCategories.includes(cat)) return true;
          
          return selectedMerchants.some(merchant => {
            const merchantCats = merchantCategories[merchant] || [];
            return merchantCats.includes(cat);
          });
        });
      }
      
      if (selectedStatuses.length > 0) {
        filteredCategories = filteredCategories.filter(cat => {
          // Always include already selected categories
          if (selectedCategories.includes(cat)) return true;
          
          const catStatuses = categoryStatuses[cat] || [];
          return selectedStatuses.some(status => catStatuses.includes(status));
        });
      }
      
      const categoriesHtml = filteredCategories.map(cat => `
            <label class="flex items-center">
          <input type="checkbox" name="filter_params[categories][]" value="${cat}" class="mr-2 category-checkbox" ${selectedCategories.includes(cat) ? 'checked' : ''}>
          <span class="text-sm text-gray-700 dark:text-gray-300">${cat}</span>
            </label>
      `).join('');
      
      const filterNote = (selectedMerchants.length > 0 || selectedStatuses.length > 0) ? ' (filtered)' : '';
      
      html = `
        <div class="bg-gray-50 dark:bg-primary-950 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
          <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Category Filter${filterNote}</h4>
          <div class="space-y-2 max-h-48 overflow-y-auto">
            ${categoriesHtml || '<p class="text-sm text-gray-500 dark:text-gray-400 italic">No categories found</p>'}
          </div>
        </div>
      `;
    } else if (filterType === 'merchant') {
      // Filter merchants based on selected categories and statuses
      let filteredMerchants = availableMerchants;
      
      console.log(`Initial merchant count: ${filteredMerchants.length}`);
      
      if (selectedCategories.length > 0) {
        console.log(`Filtering by categories: ${selectedCategories.join(', ')}`);
        filteredMerchants = filteredMerchants.filter(merchant => {
          // Always include already selected merchants
          if (selectedMerchants.includes(merchant)) return true;
          
          const merchantCats = merchantCategories[merchant] || [];
          return selectedCategories.some(cat => merchantCats.includes(cat));
        });
        console.log(`After category filter: ${filteredMerchants.length} merchants`);
      }
      
      if (selectedStatuses.length > 0) {
        console.log(`Filtering by statuses: ${selectedStatuses.join(', ')}`);
        filteredMerchants = filteredMerchants.filter(merchant => {
          // Always include already selected merchants
          if (selectedMerchants.includes(merchant)) return true;
          
          const merchantStats = merchantStatuses[merchant] || [];
          return selectedStatuses.some(status => merchantStats.includes(status));
        });
        console.log(`After status filter: ${filteredMerchants.length} merchants`);
      }
      
      const merchantsHtml = filteredMerchants.map(merchant => `
            <label class="flex items-center">
          <input type="checkbox" name="filter_params[merchants][]" value="${merchant}" class="mr-2" ${selectedMerchants.includes(merchant) ? 'checked' : ''}>
          <span class="text-sm text-gray-700 dark:text-gray-300">${merchant}</span>
            </label>
      `).join('');
      
      const filterNote = (selectedCategories.length > 0 || selectedStatuses.length > 0) ? ' (filtered)' : '';
      
      html = `
        <div class="merchant-filter-section bg-gray-50 dark:bg-primary-950 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
          <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Merchant Filter${filterNote}</h4>
          <div class="space-y-2 max-h-48 overflow-y-auto">
            ${merchantsHtml || '<p class="text-sm text-gray-500 dark:text-gray-400 italic">No merchants found</p>'}
          </div>
        </div>
      `;
    } else if (filterType === 'status') {
      // Filter statuses based on selected categories and merchants
      let filteredStatuses = availableStatuses;
      
      if (selectedCategories.length > 0) {
        filteredStatuses = filteredStatuses.filter(status => {
          // Always include already selected statuses
          if (selectedStatuses.includes(status)) return true;
          
          const statusCats = statusCategories[status] || [];
          return selectedCategories.some(cat => statusCats.includes(cat));
        });
      }
      
      if (selectedMerchants.length > 0) {
        filteredStatuses = filteredStatuses.filter(status => {
          // Always include already selected statuses
          if (selectedStatuses.includes(status)) return true;
          
          return selectedMerchants.some(merchant => {
            const merchantStats = merchantStatuses[merchant] || [];
            return merchantStats.includes(status);
          });
        });
      }
      
      const statusesHtml = filteredStatuses.map(status => `
        <label class="flex items-center">
          <input type="checkbox" name="filter_params[statuses][]" value="${status}" class="mr-2" ${selectedStatuses.includes(status) ? 'checked' : ''}>
          <span class="text-sm text-gray-700 dark:text-gray-300">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
        </label>
      `).join('');
      
      const filterNote = (selectedCategories.length > 0 || selectedMerchants.length > 0) ? ' (filtered)' : '';
      
      html = `
        <div class="bg-gray-50 dark:bg-primary-950 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
          <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Status Filter${filterNote}</h4>
          <div class="space-y-2">
            ${statusesHtml || '<p class="text-sm text-gray-500 dark:text-gray-400 italic">No statuses found</p>'}
          </div>
        </div>
      `;
    } else if (filterType === 'recurring_transactions') {
      const selectedRecurring = selectedParams.recurring_transactions;
      html = `
        <div class="bg-gray-50 dark:bg-primary-950 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
          <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Recurring Transactions</h4>
          <div class="space-y-2">
            <label class="flex items-center">
              <input type="radio" name="filter_params[recurring_transactions]" value="true" class="mr-2" ${selectedRecurring === 'true' ? 'checked' : ''}>
              <span class="text-sm text-gray-700 dark:text-gray-300">From Recurring Only</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="filter_params[recurring_transactions]" value="false" class="mr-2" ${selectedRecurring === 'false' ? 'checked' : ''}>
              <span class="text-sm text-gray-700 dark:text-gray-300">Non-Recurring Only</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="filter_params[recurring_transactions]" value="both" class="mr-2" ${selectedRecurring === 'both' ? 'checked' : ''}>
              <span class="text-sm text-gray-700 dark:text-gray-300">Both</span>
            </label>
          </div>
        </div>
      `;
    }
    
    return html;
  }
  
  // Collect all currently selected parameters
  function getAllSelectedParams() {
    const params = {
      categories: Array.from(document.querySelectorAll('input[name="filter_params[categories][]"]:checked')).map(cb => cb.value),
      merchants: Array.from(document.querySelectorAll('input[name="filter_params[merchants][]"]:checked')).map(cb => cb.value),
      statuses: Array.from(document.querySelectorAll('input[name="filter_params[statuses][]"]:checked')).map(cb => cb.value),
      recurring_transactions: document.querySelector('input[name="filter_params[recurring_transactions]]:checked')?.value
    };
    console.log('getAllSelectedParams:', params);
    return params;
  }
  
  // Update filter parameters display when checkboxes change
  function updateFilterParams() {
    const selectedTypes = Array.from(filterCheckboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);
    
    // Get all selected parameters for cross-filtering
    const selectedParams = getAllSelectedParams();
    
    // Update visual state of checkbox labels
    filterCheckboxes.forEach(checkbox => {
      const label = checkbox.closest('.filter-type-label');
      if (label) {
        if (checkbox.checked) {
          label.classList.add('bg-primary-100', 'dark:bg-primary-900', 'border-primary-500', 'dark:border-primary-500');
          label.classList.remove('border-gray-200', 'dark:border-gray-600');
        } else {
          label.classList.remove('bg-primary-100', 'dark:bg-primary-900', 'border-primary-500', 'dark:border-primary-500');
          label.classList.add('border-gray-200', 'dark:border-gray-600');
        }
      }
    });
    
    if (selectedTypes.length === 0) {
      filterParamsDiv.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 italic">Select at least one filter type above</p>';
      return;
    }
    
    // Render parameters for each selected type with all selected params for cross-filtering
    filterParamsDiv.innerHTML = selectedTypes.map(type => renderFilterParams(type, selectedParams)).join('');
  }
  
  // Use event delegation for parameter checkboxes to avoid re-attaching listeners
  filterParamsDiv.addEventListener('change', function(e) {
    if (e.target.matches('input[name^="filter_params["]')) {
      updateFilterParams();
    }
  });
  
  // Add event listeners to all checkboxes
  filterCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateFilterParams);
  });
  
  // Initial update
  updateFilterParams();
  
  // Date range selection handler
  const dateRangeRadios = document.querySelectorAll('input[name="date_range"]');
  const customDateRangeDiv = document.getElementById('custom-date-range');
  
  function updateDateRangeDisplay() {
    const selectedRange = document.querySelector('input[name="date_range"]:checked');
    
    // Update visual state of radio button labels
    document.querySelectorAll('.date-range-label').forEach(label => {
      const radio = label.querySelector('input[type="radio"]');
      if (radio.checked) {
        label.classList.add('bg-primary-100', 'dark:bg-primary-900', 'border-primary-500', 'dark:border-primary-500');
        label.classList.remove('border-gray-200', 'dark:border-gray-600');
      } else {
        label.classList.remove('bg-primary-100', 'dark:bg-primary-900', 'border-primary-500', 'dark:border-primary-500');
        label.classList.add('border-gray-200', 'dark:border-gray-600');
      }
    });
    
    // Show/hide custom date range inputs
    if (selectedRange && selectedRange.value === 'custom') {
      customDateRangeDiv.classList.remove('hidden');
    } else {
      customDateRangeDiv.classList.add('hidden');
    }
  }
  
  // Add event listeners to date range radio buttons
  dateRangeRadios.forEach(radio => {
    radio.addEventListener('change', updateDateRangeDisplay);
  });
  
  // Form submission
  const filterForm = document.getElementById('filter-form');
  filterForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const selectedTypes = formData.getAll('filter_types[]');
    
    if (selectedTypes.length === 0) {
      alert('Please select at least one filter type');
      return;
    }
    
    // Collect date range
    const dateRange = formData.get('date_range');
    let startDate = null;
    let endDate = null;
    
    if (dateRange) {
      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth();
      const currentDate = today.getDate();
      
      switch(dateRange) {
        case 'today':
          startDate = today.toISOString().split('T')[0];
          endDate = today.toISOString().split('T')[0];
          break;
        case 'current_week':
          const startOfWeek = new Date(today);
          startOfWeek.setDate(today.getDate() - today.getDay());
          startDate = startOfWeek.toISOString().split('T')[0];
          endDate = today.toISOString().split('T')[0];
          break;
        case 'current_month':
          startDate = new Date(currentYear, currentMonth, 1).toISOString().split('T')[0];
          endDate = today.toISOString().split('T')[0];
          break;
        case 'last_month':
          const lastMonth = new Date(currentYear, currentMonth - 1, 1);
          const lastDayOfLastMonth = new Date(currentYear, currentMonth, 0);
          startDate = lastMonth.toISOString().split('T')[0];
          endDate = lastDayOfLastMonth.toISOString().split('T')[0];
          break;
        case '3_months':
          const threeMonthsAgo = new Date(currentYear, currentMonth - 3, 1);
          startDate = threeMonthsAgo.toISOString().split('T')[0];
          endDate = today.toISOString().split('T')[0];
          break;
        case '6_months':
          const sixMonthsAgo = new Date(currentYear, currentMonth - 6, 1);
          startDate = sixMonthsAgo.toISOString().split('T')[0];
          endDate = today.toISOString().split('T')[0];
          break;
        case 'current_year':
          startDate = new Date(currentYear, 0, 1).toISOString().split('T')[0];
          endDate = today.toISOString().split('T')[0];
          break;
        case 'custom':
          startDate = formData.get('custom_start_date');
          endDate = formData.get('custom_end_date');
          break;
      }
    }
    
    const filterData = {
      name: formData.get('name'),
      filter_types: selectedTypes,
      filter_params: {},
      date_range: {
        type: dateRange,
        start_date: startDate,
        end_date: endDate
      }
    };
    
    // Collect filter parameters for all selected types
    if (selectedTypes.includes('category')) {
      const categories = formData.getAll('filter_params[categories][]');
      if (categories.length > 0) {
      filterData.filter_params.categories = categories;
      }
    }
    
    if (selectedTypes.includes('merchant')) {
      const merchants = formData.getAll('filter_params[merchants][]');
      if (merchants.length > 0) {
        filterData.filter_params.merchants = merchants;
      }
    }
    
    if (selectedTypes.includes('status')) {
      const statuses = formData.getAll('filter_params[statuses][]');
      if (statuses.length > 0) {
        filterData.filter_params.statuses = statuses;
      }
    }
    
    if (selectedTypes.includes('recurring_transactions')) {
      const recurring = formData.get('filter_params[recurring_transactions]');
      if (recurring) {
        filterData.filter_params.recurring_transactions = recurring;
      }
    }
    
    // Determine if we're creating or updating
    const isEditMode = this.dataset.mode === 'edit';
    const filterId = this.dataset.filterId;
    const url = isEditMode ? `/filters/${filterId}` : '/filters';
    const method = isEditMode ? 'PATCH' : 'POST';
    
    // Submit the form
    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      },
      body: JSON.stringify({ filter: filterData })
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.error || `Server error: ${response.status}`);
        }).catch(() => {
          return response.text().then(text => {
            throw new Error(`Server error: ${response.status} - ${text.substring(0, 200)}`);
          });
        });
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // If editing a filter, reload with the filter_id to show updated chart
        if (isEditMode && filterId) {
          window.location.href = `/analysis?filter_id=${filterId}`;
        } else {
        location.reload(); // Reload to show the new filter
        }
      } else {
        alert('Error saving filter: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error creating filter: ' + error.message);
    });
  });
}

// Run on initial load
initializeFilterDropdown();

// Re-run on Turbo navigation
document.addEventListener('turbo:load', initializeFilterDropdown);

</script>
